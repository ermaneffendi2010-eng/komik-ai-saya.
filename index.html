<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio Komik Epik - Erman Effendi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&family=Bangers&display=swap');
        
        body { font-family: 'Quicksand', sans-serif; background-color: #f8fafc; color: #1e293b; margin: 0; }
        .comic-font { font-family: 'Bangers', cursive; letter-spacing: 1px; }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.08);
        }

        .comic-border {
            border: 4px solid #0f172a;
            box-shadow: 10px 10px 0px #0f172a;
        }

        .loader-spin {
            border: 4px solid #f1f5f9;
            border-top: 4px solid #f97316;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .image-container {
            width: 100%;
            aspect-ratio: 1/1;
            background: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            border-radius: 1.5rem;
        }

        .style-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 12px;
        }

        .style-option input[type="radio"]:checked + .style-card {
            border-color: #f97316;
            background-color: #fff7ed;
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(249, 115, 22, 0.2);
        }
        
        .style-card {
            border: 2px solid #e2e8f0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .nav-btn {
            background: #0f172a;
            color: white;
            padding: 1rem;
            border-radius: 9999px;
            transition: all 0.2s;
        }
        .nav-btn:active { transform: scale(0.9); }
        .nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 md:p-8">

    <div class="w-full max-w-3xl">
        
        <!-- Layar Pengaturan -->
        <div id="setup-screen" class="glass-card rounded-[3rem] p-8 md:p-12">
            <header class="text-center mb-10">
                <h1 class="text-5xl md:text-6xl text-orange-500 comic-font mb-2 uppercase italic">Studio Komik Epik</h1>
                <p class="text-slate-400 font-bold tracking-widest text-sm uppercase">Produser: Erman Effendi</p>
                <div class="h-1.5 w-24 bg-gradient-to-r from-orange-400 to-red-500 mx-auto mt-6 rounded-full"></div>
            </header>

            <div class="space-y-8">
                <!-- Panel Konfigurasi (Opsional) -->
                <div class="bg-slate-50 p-6 rounded-3xl border border-slate-200">
                    <label class="block text-xs font-black text-slate-500 mb-2 uppercase tracking-tighter">Pusat Kendali API (Cadangan):</label>
                    <input type="password" id="custom-api-key" placeholder="Masukkan API Key Anda jika terjadi error" 
                        class="w-full px-5 py-3 rounded-2xl border-2 border-white focus:border-orange-300 outline-none transition-all shadow-inner text-sm">
                    <p class="text-[10px] text-slate-400 mt-2 font-medium">‚ö†Ô∏è Biarkan kosong untuk menggunakan sistem otomatis. Isi jika aplikasi macet saat online.</p>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2 ml-1">Nama Pahlawan</label>
                        <input type="text" id="char-name" placeholder="Contoh: Kancil Sakti" 
                            class="w-full px-6 py-4 rounded-2xl border-2 border-slate-100 focus:border-orange-400 outline-none transition-all bg-white shadow-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2 ml-1">Tema Petualangan</label>
                        <input type="text" id="story-theme" placeholder="Contoh: Menjelajah Bulan" 
                            class="w-full px-6 py-4 rounded-2xl border-2 border-slate-100 focus:border-orange-400 outline-none transition-all bg-white shadow-sm">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-4 ml-1">Pilih Gaya Gambar:</label>
                    <div class="style-grid" id="style-container"></div>
                </div>

                <button id="generate-trigger" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-5 rounded-[2rem] text-2xl comic-font transition-all transform active:scale-[0.98] shadow-2xl shadow-orange-200 uppercase tracking-wider">
                    Mulai Lukis Cerita üé¨
                </button>
            </div>
        </div>

        <!-- Layar Loading -->
        <div id="loading-screen" class="hidden fixed inset-0 bg-slate-50/98 z-50 flex flex-col items-center justify-center p-10 text-center">
            <div class="loader-spin mb-8 scale-150"></div>
            <h2 id="loading-status" class="text-4xl font-bold text-slate-800 comic-font mb-4 uppercase">AI Sedang Melukis...</h2>
            <p class="text-slate-500 max-w-sm font-medium leading-relaxed">Harap tunggu, kami sedang menyusun cerita dan imajinasi untuk Anda.</p>
        </div>

        <!-- Layar Viewer Komik -->
        <div id="viewer-screen" class="hidden space-y-6">
            <div class="flex items-center justify-between bg-white p-4 rounded-[2.5rem] shadow-xl border border-slate-100">
                <button id="prev-btn" class="nav-btn">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7"/></svg>
                </button>
                <div class="text-center">
                    <span id="page-num" class="comic-font text-2xl text-orange-500 bg-orange-50 px-6 py-2 rounded-2xl">HALAMAN 1 / 15</span>
                </div>
                <button id="next-btn" class="nav-btn">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7"/></svg>
                </button>
            </div>

            <div class="bg-white rounded-[3rem] p-5 comic-border">
                <div class="image-container">
                    <div id="img-loader" class="absolute inset-0 z-10 bg-slate-50 flex flex-col items-center justify-center">
                        <div class="loader-spin mb-4"></div>
                        <p class="text-xs font-black text-slate-400 uppercase tracking-[0.2em]">Merender Visual...</p>
                    </div>
                    <img id="comic-image" src="" class="w-full h-full object-cover transition-opacity duration-1000 opacity-0">
                </div>
                
                <div class="mt-8 mb-4 px-4 text-center">
                    <div class="inline-block px-4 py-1 bg-orange-500 text-white text-[10px] font-black uppercase rounded-full mb-4">Narasi & Dialog</div>
                    <p id="narasi-text" class="text-xl font-bold text-slate-800 leading-snug mb-4"></p>
                    <p id="dialog-text" class="text-2xl text-orange-600 font-bold comic-font italic"></p>
                </div>
            </div>

            <div class="flex gap-4">
                <button onclick="location.reload()" class="flex-1 py-4 bg-slate-200 hover:bg-slate-300 text-slate-600 font-bold rounded-2xl transition-all uppercase text-xs tracking-widest">
                    Buat Baru
                </button>
                <button id="download-btn" class="flex-1 py-4 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-2xl transition-all uppercase text-xs tracking-widest">
                    Simpan Gambar
                </button>
            </div>
        </div>

    </div>

    <script>
        let currentApiKey = ""; 
        
        const STYLES = [
            { id: "3d", name: "Pixar 3D", emoji: "üé¨", p: "3D Disney Pixar style, cinematic lighting, 8k resolution, cute character" },
            { id: "anime", name: "Ghibli", emoji: "üçÉ", p: "Studio Ghibli hand-drawn style, lush landscapes, vibrant anime aesthetic" },
            { id: "comic", name: "Komik Retro", emoji: "üìñ", p: "Vintage 1950s comic book style, Ben-Day dots, bold ink lines, retro colors" },
            { id: "water", name: "Cat Air", emoji: "üé®", p: "Soft watercolor illustration, storybook aesthetic, dreamy pastel colors" },
            { id: "clay", name: "Claymation", emoji: "üß∏", p: "Handmade clay model style, stop motion aesthetic, realistic textures" }
        ];

        let storySteps = [];
        let currentIdx = 0;
        const imageCache = new Map();

        const styleBox = document.getElementById('style-container');
        STYLES.forEach((s, i) => {
            const div = document.createElement('label');
            div.className = "style-option";
            div.innerHTML = `
                <input type="radio" name="art-style" value="${s.p}" class="hidden" ${i===0 ? 'checked' : ''}>
                <div class="style-card p-4 rounded-2xl bg-white text-center h-full">
                    <div class="text-3xl mb-1">${s.emoji}</div>
                    <div class="text-[10px] font-black uppercase text-slate-500">${s.name}</div>
                </div>
            `;
            styleBox.appendChild(div);
        });

        async function fetchWithRetry(url, options, retries = 5) {
            for (let i = 0; i < retries; i++) {
                try {
                    const res = await fetch(url, options);
                    if (res.ok) return await res.json();
                    if (res.status === 429) {
                        const wait = Math.pow(2, i) * 1500;
                        await new Promise(r => setTimeout(r, wait));
                        continue;
                    }
                    throw new Error(`HTTP ${res.status}`);
                } catch (e) {
                    if (i === retries - 1) throw e;
                    await new Promise(r => setTimeout(r, 1000));
                }
            }
        }

        async function generateStory() {
            const hero = document.getElementById('char-name').value;
            const theme = document.getElementById('story-theme').value;
            const customKey = document.getElementById('custom-api-key').value;
            const activeKey = customKey || currentApiKey;
            
            document.getElementById('loading-screen').classList.remove('hidden');

            const prompt = `Buatlah alur cerita komik anak 15 halaman tentang ${hero} dengan tema ${theme}. 
            Hasil HARUS dalam format JSON Array berisi 15 objek. 
            Format: [{"img_prompt": "english description for AI drawing", "narasi": "teks narasi indonesia", "dialog": "dialog karakter"}].`;

            try {
                const result = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${activeKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                storySteps = JSON.parse(result.candidates[0].content.parts[0].text);
                return true;
            } catch (e) {
                alert("Gagal terhubung ke AI. Silakan periksa API Key Anda.");
                document.getElementById('loading-screen').classList.add('hidden');
                return false;
            }
        }

        async function renderPage(idx) {
            const page = storySteps[idx];
            const style = document.querySelector('input[name="art-style"]:checked').value;
            const customKey = document.getElementById('custom-api-key').value;
            const activeKey = customKey || currentApiKey;

            document.getElementById('page-num').innerText = `HALAMAN ${idx + 1} / 15`;
            document.getElementById('narasi-text').innerText = page.narasi;
            document.getElementById('dialog-text').innerText = page.dialog ? `"${page.dialog}"` : "";
            
            const img = document.getElementById('comic-image');
            const loader = document.getElementById('img-loader');
            
            img.classList.add('opacity-0');
            loader.classList.remove('hidden');

            if (imageCache.has(idx)) {
                img.src = imageCache.get(idx);
                img.onload = () => { loader.classList.add('hidden'); img.classList.remove('opacity-0'); };
                return;
            }

            try {
                const drawPrompt = `${style}. Scene: ${page.img_prompt}. High quality, child friendly, vibrant.`;
                const result = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${activeKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: drawPrompt }] }],
                        generationConfig: { responseModalities: ['IMAGE'] }
                    })
                });

                const b64 = result.candidates[0].content.parts.find(p => p.inlineData).inlineData.data;
                const src = `data:image/png;base64,${b64}`;
                imageCache.set(idx, src);
                img.src = src;
                img.onload = () => { loader.classList.add('hidden'); img.classList.remove('opacity-0'); };
            } catch (e) {
                img.src = "https://placehold.co/600x600?text=Maaf,+AI+sedang+sibuk";
                img.classList.remove('opacity-0');
                loader.classList.add('hidden');
            }
        }

        document.getElementById('generate-trigger').onclick = async () => {
            if(!document.getElementById('char-name').value || !document.getElementById('story-theme').value) {
                return alert("Tolong isi nama pahlawan dan tema petualangannya ya!");
            }
            if (await generateStory()) {
                document.getElementById('setup-screen').classList.add('hidden');
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('viewer-screen').classList.remove('hidden');
                renderPage(0);
            }
        };

        document.getElementById('next-btn').onclick = () => {
            if (currentIdx < 14) { currentIdx++; renderPage(currentIdx); }
        };

        document.getElementById('prev-btn').onclick = () => {
            if (currentIdx > 0) { currentIdx--; renderPage(currentIdx); }
        };

        document.getElementById('download-btn').onclick = () => {
            const link = document.createElement('a');
            link.href = document.getElementById('comic-image').src;
            link.download = `komik-halaman-${currentIdx+1}.png`;
            link.click();
        };
    </script>
</body>
</html>
