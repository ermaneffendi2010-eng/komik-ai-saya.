<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio Komik Epik - Erman Effendi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&family=Bangers&display=swap');
        
        body { font-family: 'Quicksand', sans-serif; background-color: #fef9c3; overflow-x: hidden; }
        .comic-font { font-family: 'Bangers', cursive; letter-spacing: 1px; }
        .comic-frame { border: 6px solid #000; box-shadow: 10px 10px 0px #fbbf24; background: #fff; position: relative; }
        .image-container { width: 100%; aspect-ratio: 1/1; background-color: #f3f4f6; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        
        .loading-spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #f97316;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .ai-loading-overlay {
            position: fixed; inset: 0; background: rgba(255, 255, 255, 0.98);
            z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px;
        }
        
        #custom-alert {
            display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 200; background: #ef4444; color: white; padding: 1rem 2rem; border-radius: 1rem;
            font-weight: bold; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="custom-alert"></div>
    <div class="max-w-xl mx-auto">
        
        <!-- Layar Pengaturan -->
        <div id="setup-screen" class="bg-white p-8 rounded-[2rem] border-8 border-yellow-400 shadow-2xl">
            <h1 class="text-4xl font-bold text-orange-600 mb-1 text-center comic-font uppercase">Studio Komik Epik</h1>
            <p class="text-center text-sm font-black text-gray-800 uppercase mb-6">Oleh: Erman Effendi</p>
            
            <div class="space-y-4">
                <!-- Bagian API Key sekarang disembunyikan sepenuhnya dari pandangan user -->
                <div class="hidden">
                    <input type="password" id="api-key-input" value="AIzaSyAgjm5PCmKOQN54ZWiXxPsVKyQMDDncUTY">
                </div>

                <div class="space-y-2">
                    <label class="block font-bold text-gray-700 ml-1">Nama Karakter Kamu:</label>
                    <input type="text" id="input-karakter" placeholder="Contoh: Si Berani Budi..." class="w-full p-4 rounded-xl border-4 border-orange-100 outline-none text-lg focus:border-orange-400 transition-colors">
                </div>

                <div class="space-y-2">
                    <label class="block font-bold text-gray-700 ml-1">Tema Petualangan:</label>
                    <input type="text" id="input-tema" placeholder="Contoh: Mencari Harta di Hutan Sumatra..." class="w-full p-4 rounded-xl border-4 border-orange-100 outline-none text-lg focus:border-orange-400 transition-colors">
                </div>

                <button id="btn-generate" class="w-full mt-4 bg-orange-500 text-white font-bold py-5 rounded-2xl shadow-xl hover:bg-orange-600 text-2xl comic-font uppercase transition-all active:scale-95">
                    BUAT KOMIK SEKARANG! üöÄ
                </button>
            </div>
        </div>

        <!-- Layar Loading AI -->
        <div id="ai-loading" class="ai-loading-overlay hidden">
            <div class="loading-spinner mb-4"></div>
            <h2 id="ai-status-text" class="text-2xl font-bold text-orange-600 comic-font uppercase text-center">AI Sedang Merancang Plot...</h2>
            <p id="ai-status-subtext" class="text-gray-600 font-bold text-center">Menyusun 15 adegan unik untukmu...</p>
            <button id="retry-btn" class="mt-8 bg-orange-100 px-8 py-3 rounded-full font-bold text-orange-600 hidden border-2 border-orange-200">KEMBALI & PERBAIKI</button>
        </div>

        <!-- Layar Komik -->
        <div id="story-screen" class="hidden space-y-4">
            <div class="flex justify-between items-center bg-black text-white p-3 rounded-2xl">
                <button id="prev-btn" class="font-bold px-4 text-sm hover:text-yellow-400">‚¨ÖÔ∏è BALIK</button>
                <div class="text-center">
                    <span id="pageIndicator" class="comic-font text-yellow-400 block">HALAMAN 1 / 15</span>
                </div>
                <button id="next-btn" class="font-bold px-4 text-sm hover:text-yellow-400">LANJUT ‚û°Ô∏è</button>
            </div>

            <div class="comic-frame rounded-[2.5rem] overflow-hidden">
                <div class="image-container">
                    <div id="loader" class="hidden absolute z-30 flex flex-col items-center bg-white/90 p-4 rounded-2xl border-2 border-orange-500 shadow-xl">
                        <div class="loading-spinner mb-2"></div>
                        <p class="text-xs font-bold text-orange-600">Lagi Gambar...</p>
                    </div>
                    <img id="comic-img" src="" class="w-full h-full object-cover transition-opacity duration-500">
                </div>
                <div class="bg-white p-6 border-t-4 border-black text-center min-h-[140px] flex flex-col justify-center">
                    <p id="narasi-box" class="text-lg font-bold text-gray-800 leading-snug"></p>
                    <p id="dialog-box" class="text-orange-600 italic mt-2 font-bold text-base"></p>
                </div>
            </div>
            
            <button onclick="location.reload()" class="w-full text-gray-500 text-sm font-bold uppercase tracking-widest mt-4">Tutup & Buat Baru üîÑ</button>
        </div>
    </div>

    <script>
        // Key tetap tersimpan di variabel agar aplikasi bisa berjalan tanpa input user
        let currentApiKey = "AIzaSyAgjm5PCmKOQN54ZWiXxPsVKyQMDDncUTY";
        let currentPage = 1;
        let dynamicPageData = [];
        const imageCache = new Map();

        function showAlert(msg) {
            const alertBox = document.getElementById('custom-alert');
            alertBox.innerText = msg;
            alertBox.style.display = 'block';
            setTimeout(() => alertBox.style.display = 'none', 5000);
        }

        async function generateStory() {
            const loading = document.getElementById('ai-loading');
            const statusT = document.getElementById('ai-status-text');
            const statusS = document.getElementById('ai-status-subtext');
            const retryB = document.getElementById('retry-btn');
            
            loading.classList.remove('hidden');
            retryB.classList.add('hidden');
            statusT.innerText = "AI Sedang Merancang Plot...";

            const char = document.getElementById('input-karakter').value;
            const theme = document.getElementById('input-tema').value;

            const prompt = `Buat cerita anak 15 halaman dalam Bahasa Indonesia. Karakter: ${char}, Tema: ${theme}. 
            Kirimkan HANYA dalam format JSON array berisi 15 objek. 
            Setiap objek wajib punya: {"prompt": "visual description in english for AI image generator", "narasi": "teks narasi indonesia", "dialog": "teks dialog indonesia"}. 
            Tanpa teks tambahan.`;

            try {
                const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${currentApiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!resp.ok) {
                    const errData = await resp.json();
                    throw new Error(errData.error?.message || "Terjadi kesalahan koneksi.");
                }

                const data = await resp.json();
                let rawText = data.candidates[0].content.parts[0].text;
                rawText = rawText.replace(/```json|```/g, "").trim();
                dynamicPageData = JSON.parse(rawText);
                
                loading.classList.add('hidden');
                return true;
            } catch (e) {
                statusT.innerText = "Waduh, Gagal!";
                statusS.innerText = e.message;
                retryB.classList.remove('hidden');
                retryB.onclick = () => loading.classList.add('hidden');
                return false;
            }
        }

        async function fetchImage(promptText, pageIdx) {
            if (imageCache.has(pageIdx)) return imageCache.get(pageIdx);
            try {
                const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${currentApiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        instances: { prompt: "Cute 3D Pixar style cartoon illustration, bright colors, " + promptText },
                        parameters: { sampleCount: 1 }
                    })
                });
                if (!resp.ok) return null;
                const result = await resp.json();
                const b64 = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                imageCache.set(pageIdx, b64);
                return b64;
            } catch (e) { return null; }
        }

        async function loadPage(num) {
            currentPage = num;
            const item = dynamicPageData[num-1];
            document.getElementById('narasi-box').innerText = item.narasi || "";
            document.getElementById('dialog-box').innerText = item.dialog ? `"${item.dialog}"` : "";
            document.getElementById('pageIndicator').innerText = `HALAMAN ${num} / 15`;
            
            const imgEl = document.getElementById('comic-img');
            const loader = document.getElementById('loader');
            
            if (imageCache.has(num)) {
                imgEl.src = imageCache.get(num);
                imgEl.style.opacity = "1";
                loader.classList.add('hidden');
            } else {
                loader.classList.remove('hidden');
                imgEl.style.opacity = "0.2";
                const img = await fetchImage(item.prompt, num);
                if (img && currentPage === num) {
                    imgEl.src = img;
                    imgEl.style.opacity = "1";
                    loader.classList.add('hidden');
                }
            }
        }

        document.getElementById('btn-generate').onclick = async () => {
            const char = document.getElementById('input-karakter').value.trim();
            const theme = document.getElementById('input-tema').value.trim();

            if (!char || !theme) return showAlert("‚ö†Ô∏è Isi Nama Karakter dan Tema dulu!");

            if (await generateStory()) {
                document.getElementById('setup-screen').classList.add('hidden');
                document.getElementById('story-screen').classList.remove('hidden');
                loadPage(1);
            }
        };

        document.getElementById('next-btn').onclick = () => { if(currentPage < 15) loadPage(currentPage + 1); };
        document.getElementById('prev-btn').onclick = () => { if(currentPage > 1) loadPage(currentPage - 1); };
    </script>
</body>
</html>
