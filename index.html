<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio Komik Epik - Erman Effendi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&family=Bangers&display=swap');
        
        body { font-family: 'Quicksand', sans-serif; background-color: #f0f2f5; color: #1a202c; }
        .comic-font { font-family: 'Bangers', cursive; letter-spacing: 1px; }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .comic-border {
            border: 4px solid #000;
            box-shadow: 8px 8px 0px #000;
        }

        .loader-spin {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #f97316;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .image-viewport {
            width: 100%;
            aspect-ratio: 1/1;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            border-radius: 1.5rem;
        }

        .style-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
        }

        .style-option { cursor: pointer; }
        input[type="radio"]:checked + .style-card {
            border-color: #f97316;
            background-color: #fff7ed;
            transform: scale(1.05);
        }
        .style-card {
            border: 2px solid #f3f4f6;
            transition: all 0.2s;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-2xl">
        
        <!-- Screen 1: Form Input -->
        <div id="setup-screen" class="glass-card rounded-[2.5rem] p-6 md:p-10">
            <header class="text-center mb-8">
                <h1 class="text-4xl md:text-5xl text-orange-500 comic-font mb-2 uppercase tracking-wide">Studio Komik Epik</h1>
                <p class="text-gray-500 font-bold tracking-widest text-xs uppercase">Karya: Erman Effendi</p>
                <div class="h-1 w-20 bg-orange-400 mx-auto mt-4 rounded-full"></div>
            </header>

            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2 ml-1">Siapa Nama Hero-mu?</label>
                    <input type="text" id="char-name" placeholder="Misal: Si Kancil Cerdik" 
                        class="w-full px-5 py-3 rounded-2xl border-2 border-gray-100 focus:border-orange-400 outline-none transition-all shadow-sm">
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2 ml-1">Apa Petualangannya?</label>
                    <textarea id="story-theme" rows="2" placeholder="Misal: Mencari buah ajaib di hutan misterius..." 
                        class="w-full px-5 py-3 rounded-2xl border-2 border-gray-100 focus:border-orange-400 outline-none transition-all shadow-sm resize-none"></textarea>
                </div>

                <!-- 10 Gaya Pilihan -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-3 ml-1">Pilih Gaya Seni (10 Pilihan):</label>
                    <div class="style-grid" id="style-container">
                        <!-- Styles generated by JS -->
                    </div>
                </div>

                <button id="generate-trigger" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-4 rounded-2xl text-xl comic-font transition-all transform active:scale-95 shadow-lg shadow-orange-200 uppercase">
                    Mulai Buat Komik ðŸš€
                </button>
            </div>
        </div>

        <!-- Screen 2: Loading Overlay -->
        <div id="loading-screen" class="hidden fixed inset-0 bg-white/95 z-50 flex flex-col items-center justify-center p-6 text-center">
            <div class="loader-spin mb-6 scale-150"></div>
            <h2 id="loading-status" class="text-3xl font-bold text-orange-500 comic-font mb-2 uppercase">AI Sedang Berimajinasi...</h2>
            <p class="text-gray-500 max-w-xs font-medium">Kami sedang menyusun 15 adegan epik untuk ceritamu. Mohon tunggu ya!</p>
        </div>

        <!-- Screen 3: Comic Viewer -->
        <div id="viewer-screen" class="hidden space-y-6">
            <div class="flex items-center justify-between bg-black text-white p-4 rounded-3xl comic-border">
                <button id="prev-btn" class="p-2 hover:bg-white/20 rounded-full transition-colors">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                </button>
                <div class="text-center">
                    <p id="page-num" class="comic-font text-xl text-orange-400">HALAMAN 1 / 15</p>
                </div>
                <button id="next-btn" class="p-2 hover:bg-white/20 rounded-full transition-colors">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                </button>
            </div>

            <div class="bg-white rounded-[2.5rem] p-4 comic-border overflow-hidden">
                <div class="image-viewport">
                    <div id="img-loader" class="absolute inset-0 z-10 bg-gray-100 flex flex-col items-center justify-center">
                        <div class="loader-spin mb-4"></div>
                        <p id="img-loader-text" class="text-sm font-bold text-gray-400 uppercase tracking-widest text-center px-4">Menggambar Adegan...</p>
                    </div>
                    <img id="comic-image" src="" class="w-full h-full object-cover transition-opacity duration-700 opacity-0">
                </div>
                
                <div class="p-6 text-center space-y-4">
                    <div class="bg-orange-50 p-4 rounded-2xl border-l-8 border-orange-500">
                        <p id="narasi-text" class="text-lg font-bold text-gray-800 leading-relaxed"></p>
                    </div>
                    <p id="dialog-text" class="text-xl italic text-orange-600 font-bold comic-font"></p>
                </div>
            </div>

            <button onclick="location.reload()" class="w-full py-4 text-gray-400 font-bold hover:text-orange-500 transition-colors uppercase text-sm tracking-widest">
                Buat Cerita Baru ðŸ”„
            </button>
        </div>

    </div>

    <script>
        // Use global apiKey provided by the environment
        const apiKey = ""; 
        const APP_CONFIG = {
            PAGES: 15
        };

        const ART_STYLES = [
            { id: "pixar", name: "Pixar 3D", emoji: "ðŸŽ¬", prompt: "3D animation style, Pixar inspired, colorful, soft lighting, cute character design" },
            { id: "watercolor", name: "Cat Air", emoji: "ðŸŽ¨", prompt: "Watercolor painting style, soft edges, pastel colors, artistic, storybook illustration" },
            { id: "anime", name: "Anime", emoji: "ðŸ‡¯ðŸ‡µ", prompt: "Studio Ghibli anime style, vibrant scenery, detailed hand-drawn aesthetic" },
            { id: "retro", name: "Retro", emoji: "ðŸ“–", prompt: "Vintage comic book style, 1950s aesthetic, bold lines, halftone texture" },
            { id: "clay", name: "Lilin/Clay", emoji: "ðŸ§¸", prompt: "Stop-motion claymation style, handcrafted look, realistic clay texture" },
            { id: "sketch", name: "Pensil", emoji: "âœï¸", prompt: "Artistic pencil sketch, colored pencil shading, soft and warm aesthetic" },
            { id: "cyber", name: "Cyberpunk", emoji: "ðŸŒ†", prompt: "Futuristic digital art, neon lights, glowing accents, cinematic atmosphere" },
            { id: "pixel", name: "Pixel Art", emoji: "ðŸ‘¾", prompt: "16-bit retro game art, high quality pixel aesthetic, vibrant" },
            { id: "paper", name: "Potong Kertas", emoji: "âœ‚ï¸", prompt: "Papercut craft style, 3D layered paper look, sharp shadows" },
            { id: "lego", name: "Mainan Blok", emoji: "ðŸ§±", prompt: "Toy construction bricks style, plastic toy aesthetic, bright and fun" }
        ];

        let currentIdx = 0;
        let storyData = [];
        const cache = new Map();

        // Render Style Options
        const styleContainer = document.getElementById('style-container');
        ART_STYLES.forEach((style, index) => {
            const label = document.createElement('label');
            label.className = "style-option";
            label.innerHTML = `
                <input type="radio" name="art-style" value="${style.prompt}" class="hidden" ${index === 0 ? 'checked' : ''}>
                <div class="style-card p-3 rounded-xl bg-white text-center text-xs font-bold text-gray-600 h-full flex flex-col justify-center">
                    <span class="text-xl mb-1">${style.emoji}</span>
                    <span>${style.name}</span>
                </div>
            `;
            styleContainer.appendChild(label);
        });

        // Use gemini-2.5-flash-image-preview for much better stability
        async function fetchImageWithRetry(prompt, retries = 5) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: { responseModalities: ['TEXT', 'IMAGE'] }
            };

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    const result = await response.json();
                    const b64 = result.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                    
                    if (b64) {
                        return `data:image/png;base64,${b64}`;
                    }
                    throw new Error("No image data found");
                } catch (err) {
                    if (i === retries - 1) throw err;
                    const wait = Math.pow(2, i) * 1000;
                    await new Promise(r => setTimeout(r, wait));
                }
            }
        }

        async function generateFullStory() {
            const char = document.getElementById('char-name').value || "Seorang Pahlawan";
            const theme = document.getElementById('story-theme').value || "Petualangan seru";
            
            document.getElementById('loading-screen').classList.remove('hidden');

            const systemPrompt = "Anda adalah penulis buku cerita anak profesional. Buatlah cerita petualangan yang mendidik dan seru dalam format JSON.";
            const userQuery = `Buat cerita anak bergambar 15 halaman. Karakter: ${char}. Tema: ${theme}. 
            Hasil akhir HARUS berupa JSON array dengan tepat 15 objek. 
            Format: [{"visual": "detailed english prompt for image generation", "indo": "narasi cerita dalam bahasa indonesia", "speech": "dialog singkat"}].`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                const data = await response.json();
                const textResponse = data.candidates?.[0]?.content?.parts?.[0]?.text;
                storyData = JSON.parse(textResponse);
                return true;
            } catch (err) {
                console.error("Story Gen Error:", err);
                alert("Waduh, koneksi ke otak AI terputus. Coba lagi ya!");
                document.getElementById('loading-screen').classList.add('hidden');
                return false;
            }
        }

        async function drawPage(idx) {
            const page = storyData[idx];
            const stylePrompt = document.querySelector('input[name="art-style"]:checked').value;
            
            document.getElementById('page-num').innerText = `HALAMAN ${idx + 1} / ${APP_CONFIG.PAGES}`;
            document.getElementById('narasi-text').innerText = page.indo;
            document.getElementById('dialog-text').innerText = page.speech ? `"${page.speech}"` : "";
            
            const imgElement = document.getElementById('comic-image');
            const loader = document.getElementById('img-loader');
            const loaderText = document.getElementById('img-loader-text');
            
            imgElement.classList.add('opacity-0');
            loader.classList.remove('hidden');
            loaderText.innerText = "Menggambar Adegan...";

            if (cache.has(idx)) {
                imgElement.src = cache.get(idx);
                imgElement.onload = () => {
                    imgElement.classList.remove('opacity-0');
                    loader.classList.add('hidden');
                };
                return;
            }

            try {
                const fullPrompt = `Generate a high-quality illustration in ${stylePrompt}. Scene: ${page.visual}. Clean composition, child-friendly, vibrant.`;
                const b64 = await fetchImageWithRetry(fullPrompt);
                
                cache.set(idx, b64);
                imgElement.src = b64;
                imgElement.onload = () => {
                    imgElement.classList.remove('opacity-0');
                    loader.classList.add('hidden');
                };
            } catch (e) {
                console.error("Image Gen Error:", e);
                loaderText.innerText = "Gagal memuat gambar. Coba klik tombol Maju lalu Mundur kembali.";
                imgElement.src = "https://placehold.co/600x600?text=Gambar+Sibuk";
                imgElement.classList.remove('opacity-0');
            }
        }

        document.getElementById('generate-trigger').onclick = async () => {
            const char = document.getElementById('char-name').value.trim();
            const theme = document.getElementById('story-theme').value.trim();
            if(!char || !theme) return alert("Isi nama pahlawan dan temanya dulu ya!");

            if (await generateFullStory()) {
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('setup-screen').classList.add('hidden');
                document.getElementById('viewer-screen').classList.remove('hidden');
                drawPage(0);
            }
        };

        document.getElementById('next-btn').onclick = () => {
            if (currentIdx < APP_CONFIG.PAGES - 1) {
                currentIdx++;
                drawPage(currentIdx);
            }
        };

        document.getElementById('prev-btn').onclick = () => {
            if (currentIdx > 0) {
                currentIdx--;
                drawPage(currentIdx);
            }
        };
    </script>
</body>
</html>
